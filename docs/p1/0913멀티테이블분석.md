# 📊 토스 앱 로그 중심 멀티테이블 분석 계획서

**작성일**: 2025-09-13  
**분석 목표**: 토스 앱 사용 패턴과 개인 생활 데이터의 상관관계 발굴  
**중심 테이블**: `fact_app_logs` (124,622개 로그, 142일간)  
**조인 대상**: 4개 팩트 테이블 + 3개 차원 테이블  

---

## 🎯 분석 목표 및 가설

### 핵심 가설
1. **디지털-금융 연관성**: 토스 앱 사용량 증가 → 금융 거래 활동 증가
2. **에러-스트레스 상관관계**: 앱 에러 발생 → 다른 활동 패턴 변화 (운동량, 창작량)
3. **시간대별 멀티태스킹**: 특정 시간대에 앱 사용 + 거래 + 기타 활동 집중
4. **요일별 디지털 라이프**: 요일에 따른 앱 사용 패턴과 생활 리듬 상관관계
5. **알림-반응 패턴**: notification 도메인 로그와 즉시 거래 활동의 연관성

---

## 📋 분석 세트 설계

### 🔥 Priority 1: 핵심 비즈니스 인사이트

#### 1.1 토스 앱-금융거래 실시간 연관성 분석
**가설**: 앱 사용량이 많은 시간대/일자에 거래도 많을 것  
**조인**: `fact_app_logs` ↔ `fact_transaction_event` (by event_date, event_hour)

```sql
-- 시간대별 앱 사용량 vs 거래량 상관관계
WITH hourly_app AS (
    SELECT 
        event_date, event_hour,
        COUNT(*) as app_logs,
        COUNT(*) FILTER (WHERE app_domain = 'main') as main_usage,
        COUNT(*) FILTER (WHERE log_level = 'error') as error_logs
    FROM iceberg_scan('lake/silver/fact_app_logs')
    GROUP BY event_date, event_hour
),
hourly_trans AS (
    SELECT 
        event_date, 
        EXTRACT(hour FROM datetime) as event_hour,
        COUNT(*) as transactions,
        SUM(ABS(amount)) as total_amount
    FROM iceberg_scan('lake/silver/fact_transaction_event')
    WHERE datetime IS NOT NULL
    GROUP BY event_date, EXTRACT(hour FROM datetime)
)
SELECT 
    a.event_date, a.event_hour,
    a.app_logs, a.main_usage, a.error_logs,
    COALESCE(t.transactions, 0) as transactions,
    COALESCE(t.total_amount, 0) as total_amount,
    -- 상관관계 지표
    CASE WHEN a.app_logs > 0 AND COALESCE(t.transactions, 0) > 0 THEN 'BOTH_ACTIVE'
         WHEN a.app_logs > 0 THEN 'ONLY_APP'
         WHEN COALESCE(t.transactions, 0) > 0 THEN 'ONLY_TRANSACTION'
         ELSE 'INACTIVE' END as activity_pattern
FROM hourly_app a
LEFT JOIN hourly_trans t ON a.event_date = t.event_date AND a.event_hour = t.event_hour
ORDER BY a.event_date DESC, a.event_hour;
```

**기대 인사이트**: 
- 앱 사용 후 N분 내 거래 발생 패턴
- 에러 발생 시간대와 거래 실패/재시도 관계
- 실시간 금융 행동 예측 가능성

#### 1.2 앱 에러와 스트레스 지표 분석  
**가설**: 앱 에러 발생일에 신체 활동량이나 창작 활동이 변화할 것  
**조인**: `fact_app_logs` ↔ `fact_movement` ↔ `fact_obsidian_notes` (by event_date)

```sql
-- 앱 에러 발생일 vs 다른 활동 변화
WITH daily_app_errors AS (
    SELECT 
        event_date,
        COUNT(*) as total_logs,
        COUNT(*) FILTER (WHERE log_level = 'error') as error_count,
        ROUND(COUNT(*) FILTER (WHERE log_level = 'error') * 100.0 / COUNT(*), 1) as error_rate
    FROM iceberg_scan('lake/silver/fact_app_logs')
    GROUP BY event_date
),
daily_wellness AS (
    SELECT 
        event_date,
        SUM(steps) as daily_steps,
        SUM(active_calories) as daily_calories
    FROM iceberg_scan('lake/silver/fact_movement')
    WHERE steps > 0
    GROUP BY event_date
),
daily_creativity AS (
    SELECT 
        created_date as event_date,
        SUM(word_count) as daily_words
    FROM iceberg_scan('lake/silver/fact_obsidian_notes')
    GROUP BY created_date
)
SELECT 
    e.event_date,
    e.total_logs,
    e.error_count,
    e.error_rate,
    COALESCE(w.daily_steps, 0) as steps,
    COALESCE(w.daily_calories, 0) as calories,
    COALESCE(c.daily_words, 0) as words,
    -- 스트레스 지수 (에러율 기반)
    CASE 
        WHEN e.error_rate >= 5.0 THEN 'HIGH_STRESS'
        WHEN e.error_rate >= 2.0 THEN 'MEDIUM_STRESS'
        WHEN e.error_rate > 0 THEN 'LOW_STRESS'
        ELSE 'NO_STRESS'
    END as stress_level
FROM daily_app_errors e
LEFT JOIN daily_wellness w ON e.event_date = w.event_date
LEFT JOIN daily_creativity c ON e.event_date = c.event_date
ORDER BY e.error_rate DESC, e.event_date DESC;
```

#### 1.3 알림-반응 즉시성 분석
**가설**: notification 로그 후 main 사용까지의 반응 시간 패턴  
**조인**: `fact_app_logs` self-join (by event_date, 시간 차이 계산)

```sql
-- 알림 후 메인 앱 사용까지의 반응 시간
WITH notification_logs AS (
    SELECT 
        event_date, datetime,
        ROW_NUMBER() OVER (PARTITION BY event_date ORDER BY datetime) as seq
    FROM iceberg_scan('lake/silver/fact_app_logs')
    WHERE app_domain = 'notification'
),
main_logs AS (
    SELECT 
        event_date, datetime,
        ROW_NUMBER() OVER (PARTITION BY event_date ORDER BY datetime) as seq
    FROM iceberg_scan('lake/silver/fact_app_logs')
    WHERE app_domain = 'main'
)
SELECT 
    n.event_date,
    n.datetime as notification_time,
    m.datetime as main_response_time,
    EXTRACT(EPOCH FROM (m.datetime - n.datetime))/60 as response_minutes,
    CASE 
        WHEN EXTRACT(EPOCH FROM (m.datetime - n.datetime))/60 <= 1 THEN 'IMMEDIATE'
        WHEN EXTRACT(EPOCH FROM (m.datetime - n.datetime))/60 <= 5 THEN 'QUICK'
        WHEN EXTRACT(EPOCH FROM (m.datetime - n.datetime))/60 <= 30 THEN 'DELAYED'
        ELSE 'VERY_DELAYED'
    END as response_pattern
FROM notification_logs n
LEFT JOIN main_logs m ON n.event_date = m.event_date 
    AND m.datetime > n.datetime
    AND m.seq = (
        SELECT MIN(seq) FROM main_logs m2 
        WHERE m2.event_date = n.event_date AND m2.datetime > n.datetime
    )
WHERE EXTRACT(EPOCH FROM (m.datetime - n.datetime))/60 <= 60  -- 1시간 이내 반응만
ORDER BY n.event_date DESC, n.datetime DESC
LIMIT 100;
```

### 🔍 Priority 2: 생활 패턴 심화 분석

#### 2.1 멀티모달 활동 클러스터링
**목표**: 토스 앱 + 운동 + 창작 + 사진이 동시에 활발한 날 패턴 발굴

#### 2.2 위치 기반 앱 사용 패턴 (Spatial Analysis)
**조인**: `fact_app_logs` ↔ `fact_photo_metadata` (GPS) ↔ `dim_bus_stop` (근접성)

#### 2.3 계절성 및 트렌드 분석
**조인**: 모든 테이블 ↔ `dim_date` (월별, 요일별, 주말/평일)

### 🚀 Priority 3: 예측 모델링 기초

#### 3.1 앱 사용량 기반 거래 예측
#### 3.2 에러 패턴 기반 사용성 개선
#### 3.3 개인화된 금융 활동 시점 추천

---

## 🛠️ 실행 계획

### Phase 1: 기초 데이터 검증 (30분)
- [ ] 테이블 간 조인 가능한 날짜 범위 확인
- [ ] 데이터 품질 및 누락값 패턴 분석
- [ ] 주요 도메인별 로그 분포 정제

### Phase 2: Priority 1 분석 실행 (60분)
- [ ] 1.1 토스 앱-금융거래 실시간 연관성
- [ ] 1.2 앱 에러와 스트레스 지표 
- [ ] 1.3 알림-반응 즉시성
- [ ] 각 분석별 CSV 결과 저장 및 쿼리 로깅

### Phase 3: 심화 분석 (90분)
- [ ] Priority 2 생활 패턴 분석
- [ ] 통계적 유의성 검정
- [ ] 상관계수 및 회귀 분석

### Phase 4: 인사이트 종합 (30분)
- [ ] 핵심 발견사항 요약
- [ ] 실용적 활용 방안 도출
- [ ] 추가 분석 기회 식별

---

## 📊 예상 산출물

### 1. 분석 결과 파일
- `20250913_*_토스앱금융거래연관성.csv`
- `20250913_*_앱에러스트레스지표.csv` 
- `20250913_*_알림반응패턴.csv`
- `query_log_20250913.json` (모든 쿼리 기록)

### 2. 핵심 인사이트
- **금융 행동 예측 가능성**: 앱 사용 → 거래 발생 시간 간격
- **디지털 웰빙 지표**: 에러율과 신체/정신 활동 상관관계
- **최적 UX 개선점**: 알림-반응 시간 최적화 방안

### 3. 개인화 추천 시스템 기초
- 개인별 최적 거래 시점 예측
- 앱 사용 패턴 기반 스트레스 관리
- 멀티태스킹 효율성 극대화 시간대

---

## 🔧 기술적 고려사항

### 성능 최적화
- 큰 테이블 조인 시 날짜 범위 제한
- 인덱스 활용 가능한 조인 키 우선 사용
- 결과 크기 제한으로 메모리 사용량 관리

### 데이터 품질
- 시간대 불일치 보정 (timezone 고려)
- NULL 값 처리 전략 명확화
- 이상치 탐지 및 필터링

### 쿼리 로깅
- 모든 실행 쿼리 JSON 형태로 기록
- 실행 시간, 결과 행 수, 에러 메시지 포함
- 재현 가능성을 위한 완전한 SQL 보존

---

## 🎯 성공 지표

### 정량적 지표
- [ ] 10개 이상 의미있는 상관관계 패턴 발견
- [ ] 통계적 유의성 (p<0.05) 확보된 분석 5개 이상
- [ ] 실행 가능한 개인화 추천 3개 이상 도출

### 정성적 지표  
- [ ] 개인 금융 행동의 새로운 인사이트 발굴
- [ ] 디지털 웰빙 개선을 위한 구체적 방안 제시
- [ ] 토스 앱 UX 최적화 관점에서의 발견사항

---

**다음 단계**: Phase 1 기초 데이터 검증부터 시작하여 체계적으로 분석을 진행하고, 모든 쿼리와 결과를 완전히 기록하여 재현 가능한 분석 파이프라인을 구축합니다.